# IAC Automation for AKS to access ACR 

## Change from Service Principal to Managed Identity with terraform or AZ-cli for an AKS (Azure Kubernetes Service) using ACR (Azure Container Registry)


### Managed Identity

First of all we need to understand Managed Identity.

Is a secure and automated way to manage and authenticate identities for resources in Azure. Managed Identity eliminates the need for developers to manage credentials manually, which can help reduce the risk of security breaches and simplify the development process.

### Managed Identity with AKS

Then we need to understand managed identity in AKS.

When you enable Managed Identity for an AKS cluster, it generates **two identities**: one for the cluster itself, and one for the nodes that make up the cluster.

The two identities generated by AKS Managed Identity are:

**Control Plane Managed Identity**: This is a Kubernetes service account that's created in the namespace where your AKS cluster is running. The service account is associated with the Azure Active Directory (AAD) identity of the AKS cluster, and it can be used to access Azure resources such as storage accounts, Key Vault, and Azure AD.

**Kubelet Managed Identity**: This is a Managed Identity that's created for each node in the AKS cluster. The identity is used to authenticate with Azure resources that the node needs to access, such as storage accounts or Azure Container Registry (ACR).

### Managed Identity with AKS and ACR 

> For our scenario we need to make sure The Kubelet Identity has the right permissions to access ACR

For this automation the control plane has to be able to managed the kubelet identity. It will be the one assigning it. So it needs to have also permission for it.

In this scenario we will use bring your own Control Plane Identity and Kubelete Identity.

#### With Terraform 

For control plane:

```tf
resource "azurerm_user_assigned_identity" "cp-identity" {
  name                = "cp-identity"
  location            = "Location"
  resource_group_name = "rg-name"
}
resource "azurerm_role_assignment" "cp-identity" {
  scope                = azurerm_user_assigned_identity.cp-identity.id
  role_definition_name = "Managed Identity Operator"
  principal_id         = azurerm_user_assigned_identity.aks.principal_id
}
```

For the kubelet:
```tf
resource "azurerm_user_assigned_identity" "kubelet-identity" {
  location            = "Location"
  name                = "kubelet-identity"
  resource_group_name = "rg-name"
}

resource "azurerm_role_assignment" "kubelet-identity" {
  scope              = "Container registry ID"
  role_definition_name = "acrPull"
  principal_id       = azurerm_user_assigned_identity.kubelet-identity.principal_id
}
```

Then we need to pass both identities in the AKS terraform resource:

```tf
identity {
  type = "UserAssigned"
  identity_ids = [azurerm_user_assigned_identity.cp-identity.id]
} 
kubelet_identity {
  client_id                 = azurerm_user_assigned_identity.kubelet-identity.client_id
  object_id                 = azurerm_user_assigned_identity.kubelet-identity.principal_id
  user_assigned_identity_id = azurerm_user_assigned_identity.kubelet-identity.id
}
```

#### With Azure CLI

For control plane:
```bash
az identity create --name cp-identity --resource-group myResourceGroup

az role assignment create --role "Managed Identity Operator" --scope "<CPidentity-resource-id>"
```
For the kubelet:
```bash
az identity create --name kubelet-dentity --resource-group myResourceGroup

az role assignment create --role "acrPull" --scope "<kubelet-identity-resource-id>"
```
Creating/Updating the cluster:

```bash
az aks update \
    --resource-group myResourceGroup \
    --name myManagedCluster \
    --enable-managed-identity \
    --assign-identity <cp-identity-resource-id> \
    --assign-kubelet-identity <kubelet-identity-resource-id>
```

